name: Reusable SAST Pipeline

######## IMPORTANT ######## 
# Variables to set:
# scantool - must be set - [semgrep, sonarqube, bearer, codeql]
# language - Must be set of the code must be set to know which Scanning Type / File will be used
# project_dir - Must be set to knw know which Directory to scan, " ./ " will be the default. 
# environment - Must be set to know if the pipeline should stop or continue on error - non-prod has 'continue-on-error: true' all other environments will be stopped if the scans give an error.
  # non-prod has 'continue-on-error: true' all other environments will be stopped if the scans give an error-code that is not "0" !!!
# secrets:
  # SEMGREP_APP_TOKEN:
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write
   
jobs:
  SAST-Scan-semgrep:
    uses: marekboodt/Security-Scanning-Repo/.github/workflows/02-sast-workflow.yml@main
    with:
      scantool: semgrep # Options: [semgrep, sonarqube (coming soon), bearer, codeql]
      # language: python, javascript # (Optional) For CodeQL, comma-separated list
      project_dir: ./src
      environment: non-prod # options: prod, non-prod | non-prod: does not block pipeline on findings (continue-on-error); prod: blocks pipeline if findings are found
    secrets: # Set these as GitHub repository secrets or variables. If not using Semgrep or SonarQube, these can be left empty.
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}

  SAST-Scan-bearer:
    uses: marekboodt/Security-Scanning-Repo/.github/workflows/02-sast-workflow.yml@main
    with:
      scantool: bearer # Options: [semgrep, sonarqube (coming soon), bearer, codeql]
      # language: python, javascript # (Optional) For CodeQL, comma-separated list
      project_dir: ./src
      environment: non-prod # options: prod, non-prod | non-prod: does not block pipeline on findings (continue-on-error); prod: blocks pipeline if findings are found
    secrets: # Set these as GitHub repository secrets or variables. If not using Semgrep or SonarQube, these can be left empty.
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}

  SAST-Scan-codeql:
    uses: marekboodt/Security-Scanning-Repo/.github/workflows/02-sast-workflow.yml@main
    with:
      scantool: codeql # Options: [semgrep, sonarqube (coming soon), bearer, codeql]
      # language: python, javascript # (Optional) For CodeQL, comma-separated list
      project_dir: ./src
      environment: non-prod # options: prod, non-prod | non-prod: does not block pipeline on findings (continue-on-error); prod: blocks pipeline if findings are found
    secrets: # Set these as GitHub repository secrets or variables. If not using Semgrep or SonarQube, these can be left empty.
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}

  DAST-Scan:
    uses: marekboodt/Security-Scanning-Repo/.github/workflows/04-dast-workflow.yml@main
    with:
      scantool: zap # must be set one of these [zap] - zap is the standard
 #     language: python, javascript # best practice for CodeQL, CAN be left empty - how to use: language: language1, language2, languageN
      project_dir: ./src
      environment: non-prod   # non-prod has 'continue-on-error: true' all other environments will be stopped if the scans give an error.
      # # <-- Devs set this for their stack
      start_command: python blog/manage.py runserver
      # 'https://www.zaproxy.org/'
      website_target: 'http://localhost:8000'
#    secrets:
#      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#      SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}

# ======================== OLDER ONES ============================




#  Prod-SAST-scan:
#    uses: marekboodt/Security-Scanning-Repo/.github/workflows/sast-custom-workflow.yml@main
#    with:
#      scantool: semgrep
#      language: python
#      project_dir: ./src
#      # non-prod has 'continue-on-error: true' all other environments will be stopped if the scans give an error.
#      environment: prod

#  NonProd-SCA-scan:
#    uses: marekboodt/Security-Scanning-Repo/.github/workflows/sca-workflow.yml@main
#    with:
#      language: python
#      project_dir: ./
#      # non-prod has 'continue-on-error: true' all other environments will be stopped if the scans give an error.
#      environment: non-prod
      
